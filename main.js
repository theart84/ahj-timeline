(()=>{"use strict";class t{constructor(t,e,i){this.type=t,this.message=e,this.coordinates=i}markup(){let t={};t="audio"===this.type?{type:"audio",attr:{class:["post__audio"],src:this.message,controls:""},content:""}:"video"===this.type?{type:"video",attr:{class:["post__video"],src:this.message,controls:""},content:""}:{type:"div",attr:{class:["post__text"]},content:this.message};const e=new Date,i=`${e.toLocaleDateString()} ${e.toLocaleTimeString().slice(0,5)}`;return{type:"div",attr:{class:["post"],"data-post-id":Date.now()},content:[{type:"div",attr:{class:["post__header"]},content:i},{type:"div",attr:{class:["post__body"]},content:t},{type:"div",attr:{class:["post__coordinates"]},content:[{type:"span",attr:{class:["post__icon"]},content:""},{type:"span",attr:{class:["post__description"]},content:this.coordinates}]}]}}}const e=new class{constructor(){this.handlers=[]}subscribe(t,e,i){void 0===i&&(i=e),this.handlers.push({event:t,handler:e.bind(i)})}emit(t,e){this.handlers.forEach((i=>{i.event===t&&(Array.isArray(e)?i.handler.call(null,...e):i.handler(e))}))}};const i=new class{generate(t){if(!1===t||null==t)return document.createTextNode("");if("string"!=typeof t.type)return document.createTextNode("");const e=document.createElement(`${t.type}`);return t.attr&&Object.entries(t.attr).forEach((([t,i])=>{"class"===t?e.className=i.join(" "):e.setAttribute(t,i)})),t.listener&&(Array.isArray(t.listener)?t.listener.forEach((t=>e.addEventListener(t.type,t.cb))):e.addEventListener(t.listener.type,t.listener.cb)),"string"==typeof t.content?(""===t.content&&(e.textContent=""),e.textContent=t.content):Array.isArray(t.content)?t.content.forEach((t=>e.appendChild(this.generate(t)))):"object"==typeof t.content&&e.appendChild(this.generate(t.content)),e}};class s{constructor(t){this.type=t,this.stream=null,this.recorder=null,this.chunks=[]}async init(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:"audio"!==this.type}),this.recorder=new MediaRecorder(this.stream),this.registerEvents()}catch(t){console.error(t)}}registerEvents(){this.recorder.addEventListener("dataavailable",(t=>this.chunks.push(t.data))),this.recorder.addEventListener("stop",(()=>{const t=new Blob(this.chunks),i=URL.createObjectURL(t);this.cancel||e.emit("received-link",i)}))}start(){this.recorder.start(1e3)}stop(){this.recorder.stop(),this.stream.getTracks().forEach((t=>t.stop()))}cancelStream(){this.cancel=!0,this.stop()}}class n{constructor(t){this.container=t}init(){this.bindToDOM(),this.registerEvents(),this.subscribeOnEvents()}registerEvents(){this.inputElement.addEventListener("keydown",(t=>{13===t.keyCode&&this.addTextPostHandler(t)})),this.micElement.addEventListener("click",(t=>{t.target.classList.contains("input__media")?this.onClickMicHandler(t):t.target.classList.contains("stop")?this.stopHandler("audio"):t.target.classList.contains("cancel")&&this.cancelHandler("audio")})),this.videoElement.addEventListener("click",(t=>{t.target.classList.contains("input__media")&&this.onClickVideoHandler(t),(t.target.classList.contains("stop")||t.target.classList.contains("cancel"))&&this.stopHandler("video")}))}bindToDOM(){this.container.appendChild(i.generate(this.markup())),this.feedContainer=this.container.querySelector(".feed__content"),this.inputElement=this.container.querySelector(".input__field"),this.micElement=this.container.querySelector(".input__media-audio"),this.micControlsElement=this.container.querySelector(".input__media-audio .input__media-controls"),this.videoControlsElement=this.container.querySelector(".input__media-video .input__media-controls"),this.videoElement=this.container.querySelector(".input__media-video")}subscribeOnEvents(){e.subscribe("manual-coords",this.addPost,this),e.subscribe("received-link",this.addMediaPost,this),e.subscribe("close-modal-info",(()=>{this.hideAudioControlElements(),this.hideVideoControlElements()}),this)}async addTextPostHandler(t){const e=await this.coordinates();this.type="text",e?this.addPost(e.coords.latitude,e.coords.longitude,t.target.value):this.currentValue=t.target.value,t.target.value=""}async coordinates(){try{return await new Promise(((t,e)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>t(e)),(t=>e(t))):e(new Error("This browser does not support Geolocation"))}))}catch(t){return e.emit("show-modal"),null}}addPost(e,s,n=this.currentValue){const o=new t(this.type,n,`[${e}, ${s}]`);this.feedContainer.insertAdjacentElement("afterbegin",i.generate(o.markup())),this.currentValue=null}async onClickMicHandler(){return this.micElement.classList.contains("input__media-audio--active")&&this.videoElement.classList.contains("input__media-video--active")?(this.videoElement.classList.remove("input__media-video--active"),this.videoControlsElement.classList.remove("input__media-controls--show"),this.videoControlsElement.classList.add("hidden"),this.micControlsElement.classList.remove("hidden"),setTimeout((()=>{this.micControlsElement.classList.add("input__media-controls--show")}),300),this.recorder.cancelStream(),this.recorder=null,this.stopTimer(),void this.createRecorder("audio",this.micElement)):this.micElement.classList.contains("input__media-audio--active")?(this.micElement.classList.remove("input__media-audio--active"),this.micControlsElement.classList.remove("input__media-controls--show"),this.micControlsElement.classList.add("hidden"),this.recorder.cancelStream(),this.recorder=null,void this.stopTimer()):(this.micElement.classList.add("input__media-audio--active"),this.micControlsElement.classList.remove("hidden"),setTimeout((()=>{this.micControlsElement.classList.add("input__media-controls--show")}),300),void this.createRecorder("audio",this.micElement))}async onClickVideoHandler(){return this.micElement.classList.contains("input__media-audio--active")&&this.videoElement.classList.contains("input__media-video--active")?(this.micElement.classList.remove("input__media-audio--active"),this.videoElement.classList.remove("input__media-video--active"),this.videoControlsElement.classList.remove("input__media-controls--show"),this.videoControlsElement.classList.add("hidden"),this.recorder.cancelStream(),this.recorder=null,void this.stopTimer()):this.micElement.classList.contains("input__media-audio--active")?(this.micControlsElement.classList.remove("input__media-controls--show"),this.micControlsElement.classList.add("hidden"),this.videoElement.classList.add("input__media-video--active"),this.videoControlsElement.classList.remove("hidden"),setTimeout((()=>{this.videoControlsElement.classList.add("input__media-controls--show")}),300),this.recorder.cancelStream(),this.recorder=null,this.stopTimer(),void this.createRecorder("video",this.videoElement)):(this.micElement.classList.add("input__media-audio--active"),this.videoElement.classList.add("input__media-video--active"),this.videoControlsElement.classList.remove("hidden"),setTimeout((()=>{this.videoControlsElement.classList.add("input__media-controls--show")}),300),void this.createRecorder("video",this.videoElement))}stopHandler(t){"audio"===t?(this.recorder.stop(),this.stopTimer(),this.hideAudioControlElements()):(this.recorder.stop(),this.stopTimer(),this.hideVideoControlElements())}cancelHandler(t){"audio"===t?(this.recorder.cancelStream(),this.recorder=null,this.stopTimer(),this.hideAudioControlElements()):(this.recorder.cancelStream(),this.recorder=null,this.stopTimer(),this.hideVideoControlElements())}async addMediaPost(t){const e=await this.coordinates();this.currentValue=t,e&&this.addPost(e.coords.latitude,e.coords.longitude,t)}hideAudioControlElements(){this.micElement.classList.remove("input__media-audio--active"),this.micControlsElement.classList.remove("input__media-controls--show"),this.micControlsElement.classList.add("hidden")}hideVideoControlElements(){this.micElement.classList.remove("input__media-audio--active"),this.videoElement.classList.remove("input__media-video--active"),this.videoControlsElement.classList.remove("input__media-controls--show"),this.videoControlsElement.classList.add("hidden")}async createRecorder(t,i){try{this.type=t,this.recorder=new s(t),await this.recorder.init(),this.recorder.start(),this.startTimer(i)}catch(t){e.emit("show-modal-info")}}startTimer(t){this.timerID=null;const e=t.querySelector(".recording-timeline"),i=Date.now();this.timerID=setInterval((()=>{const t=new Date(Date.now()-i).toTimeString().slice(3,8);e.textContent=`${t}`}),1e3)}stopTimer(){this.micElement.querySelector(".recording-timeline").textContent="00:00",this.videoElement.querySelector(".recording-timeline").textContent="00:00",clearInterval(this.timerID),this.timerID=null}markup(){return{type:"div",attr:{class:["feed"]},content:[{type:"div",attr:{class:["feed__header"]},content:{type:"h1",attr:{class:["feed__title"]},content:"My Feed"}},{type:"div",attr:{class:["feed__content"]},content:""},{type:"div",attr:{class:["feed__footer"]},content:{type:"div",attr:{class:["input__container"]},content:[{type:"input",attr:{class:["input__field"],type:"text",placeholder:"Please enter your message..."}},{type:"div",attr:{class:["input__media","input__media-audio","input__media-audio--img"]},content:{type:"div",attr:{class:["input__media-controls","hidden"]},content:[{type:"span",attr:{class:["stop","stop--img"]},content:""},{type:"span",attr:{class:["recording-timeline"]},content:"00:00"},{type:"span",attr:{class:["cancel","cancel--img"]},content:""}]}},{type:"div",attr:{class:["input__media","input__media-video","input__media-video--img"]},content:{type:"div",attr:{class:["input__media-controls","hidden"]},content:[{type:"span",attr:{class:["stop","stop--img"]},content:""},{type:"span",attr:{class:["recording-timeline"]},content:"00:00"},{type:"span",attr:{class:["cancel","cancel--img"]},content:""}]}}]}}]}}}class o{constructor(t){if(!(t instanceof HTMLElement))throw new Error("Передайте HTML элемент");this.container=t}init(){this.bindToDOM(),this.subscribeOnEvents()}render(){return i.generate({type:"div",attr:{class:["modal__form"]},content:[{type:"div",attr:{class:["modal__background"]},content:""},{type:"div",attr:{class:["modal__content"]},content:[{type:"div",attr:{class:["modal__header"]},content:"Information!"},{type:"div",attr:{class:["modal__body"]},content:[{type:"div",attr:{class:["modal__text"]},content:"Unfortunately, we were unable to determine your location, please give permission to use geolocation, or enter the coordinates manually."},{type:"form",attr:{class:["modal__form"],name:"modal-form"},listener:{type:"submit",cb:t=>this.submit(t)},content:[{type:"div",attr:{class:["form__group"]},content:[{type:"label",attr:{class:["form__label"],for:"username-field"},content:"Latitude and longitude separated by commas"},{type:"input",attr:{class:["form__input"],name:"coordinates",placeholder:"Please enter your coordinates..."},content:""},{type:"div",attr:{class:["form__hint","hidden"]},content:""}]}]}]},{type:"div",attr:{class:["modal__footer"]},content:[{type:"div",attr:{class:["modal__close"]},listener:{type:"click",cb:t=>this.close(t)},content:"Close"},{type:"div",attr:{class:["modal__ok"]},listener:{type:"click",cb:t=>this.submit(t)},content:"Ok"}]}]}]})}bindToDOM(){this.container.appendChild(this.render()),this.modalElement=this.container.querySelector(".modal__form"),this.formElement=this.modalElement.querySelector("form")}subscribeOnEvents(){e.subscribe("show-modal",this.showModal,this)}submit(t){t.preventDefault();const{formElement:i}=this;if(""===i.elements.coordinates.value)return;const s=i.elements.coordinates.value.split(",");this.validateInput(i.elements.coordinates.value)?(this.hideHint(),this.modalElement.querySelector(".modal__header").textContent="",e.emit("manual-coords",[s[0],s[1]]),this.close()):this.showHint("Enter the coordinates of the following type: 00.00000, 0.00000")}validateInput(t){return/^\[?([-+]?\d{1,2}[.]\d+),\s*([-+]?\d{1,3}[.]\d+)\]?$/gm.test(t)}close(){this.clearForm(),this.modalElement.classList.remove("active")}showModal(){this.modalElement.classList.add("active")}clearForm(){this.formElement.elements.coordinates.value=""}showHint(t){const e=this.formElement.querySelector(".form__hint");e.textContent=t,e.classList.remove("hidden")}hideHint(){const t=this.formElement.querySelector(".form__hint");t.textContent="",t.classList.add("hidden")}}class a{constructor(t){if(!(t instanceof HTMLElement))throw new Error("Передайте HTML элемент");this.container=t}init(){this.bindToDOM(),this.subscribeOnEvents()}render(){return i.generate({type:"div",attr:{class:["modal__info"]},content:[{type:"div",attr:{class:["modal__background"]},content:""},{type:"div",attr:{class:["modal__content"]},content:[{type:"div",attr:{class:["modal__header"]},content:""},{type:"div",attr:{class:["modal__body"]},content:"Your browser does not support this feature or you have denied access to it."},{type:"div",attr:{class:["modal__footer"]},content:[{type:"div",attr:{class:["modal__ok"]},listener:{type:"click",cb:()=>this.close()},content:"Ok"}]}]}]})}bindToDOM(){this.container.appendChild(this.render())}subscribeOnEvents(){e.subscribe("show-modal-info",this.showModal,this)}close(){this.modalElement.classList.remove("active"),e.emit("close-modal-info")}showModal(){this.modalElement.querySelector(".modal__header").textContent="Information!",this.modalElement.classList.add("active")}get modalElement(){return this.container.querySelector(".modal__info")}}const r=document.getElementById("root");new class{constructor(t){this.container=t}init(){this.feedContainer=new n(this.container),this.modal=new o(this.container),this.modalInfo=new a(this.container),this.feedContainer.init(),this.modal.init(),this.modalInfo.init()}}(r).init()})();